/**
 * Test PDF Demographics Generation
 * Verifies that demographic data is properly fetched and included in PDF generation
 */

require('dotenv').config();
const { createClient } = require('@supabase/supabase-js');

async function testPDFDemographics() {
  console.log('üîç TESTING PDF DEMOGRAPHICS GENERATION\n');
  
  const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL,
    process.env.SUPABASE_SERVICE_ROLE_KEY
  );
  
  // Test with Belmonte (has demographics)
  const clientId = 'ab0b4c7e-2bf0-46bc-b455-b18ef6942baa'; // Belmonte Hotel
  const dateRange = { start: '2025-11-01', end: '2025-11-30' };
  
  console.log('Step 1: Get client info...');
  const { data: client, error: clientError } = await supabase
    .from('clients')
    .select('*')
    .eq('id', clientId)
    .single();
  
  if (clientError || !client) {
    console.error('‚ùå Client not found:', clientError);
    return;
  }
  
  console.log('‚úÖ Client:', client.name);
  console.log('   Has Meta Token:', !!client.meta_access_token);
  console.log('   Ad Account ID:', client.ad_account_id);
  console.log('');
  
  console.log('Step 2: Check smart cache for demographics...');
  const { data: cacheData } = await supabase
    .from('current_month_cache')
    .select('*')
    .eq('client_id', clientId)
    .eq('period_id', '2025-11')
    .single();
  
  if (cacheData) {
    const demographicCount = cacheData.cache_data?.metaTables?.demographicPerformance?.length || 0;
    const placementCount = cacheData.cache_data?.metaTables?.placementPerformance?.length || 0;
    
    console.log('‚úÖ Cache found:');
    console.log('   Demographics:', demographicCount);
    console.log('   Placements:', placementCount);
    
    if (demographicCount > 0) {
      console.log('   Sample demographic:', JSON.stringify(cacheData.cache_data.metaTables.demographicPerformance[0], null, 2));
    }
  } else {
    console.log('‚ö†Ô∏è No cache data found - PDF will fetch from live API');
  }
  
  console.log('');
  console.log('Step 3: Simulate PDF generation flow...');
  console.log('');
  console.log('üìã PDF GENERATION CHECKLIST:');
  console.log('');
  console.log('‚úÖ 1. Client has Meta credentials:', !!client.meta_access_token && !!client.ad_account_id);
  console.log('‚úÖ 2. PDF will call: /api/fetch-meta-tables');
  console.log('‚úÖ 3. Endpoint will check smart cache first');
  console.log('‚úÖ 4. If cache empty, falls back to live Meta API');
  console.log('‚úÖ 5. Data assigned to: reportData.metaData.tables.demographicPerformance');
  console.log('‚úÖ 6. Charts generated by: generateDemographicChartsHTML()');
  console.log('‚úÖ 7. Charts render pie charts for gender & age');
  console.log('');
  console.log('üéØ EXPECTED RESULT:');
  if (cacheData && cacheData.cache_data?.metaTables?.demographicPerformance?.length > 0) {
    console.log('   ‚úÖ PDF will include demographic pie charts');
    console.log('   ‚úÖ Charts will show gender distribution');
    console.log('   ‚úÖ Charts will show age distribution');
    console.log('   ‚úÖ Data comes from smart cache (fast)');
  } else {
    console.log('   ‚ö†Ô∏è PDF will fetch demographics from Meta API (slower)');
    console.log('   ‚ö†Ô∏è If Meta API has no data, PDF will show "Brak danych demograficznych"');
  }
  
  console.log('');
  console.log('üìä TO VERIFY:');
  console.log('1. Generate a PDF for Belmonte Hotel for November 2025');
  console.log('2. Check server logs for:');
  console.log('   - "üìä Fetching Meta tables data (demographics, placement, ad relevance)..."');
  console.log('   - "‚úÖ PDF META TABLES DATA ASSIGNED: { demographicLength: XX }"');
  console.log('   - "üé® PDF DEMOGRAPHIC CHARTS GENERATION: { demographicDataLength: XX }"');
  console.log('3. Open the PDF and scroll to "Analiza Demograficzna" section');
  console.log('4. You should see pie charts showing gender and age distributions');
  console.log('');
  console.log('‚ö†Ô∏è NOTE: For Apartamenty Lambert, demographics will show "Brak danych"');
  console.log('   because the client has a Meta API permission error.');
}

testPDFDemographics().catch(console.error);

